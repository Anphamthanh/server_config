#!/bin/bash
git --work-tree=<%= @working_dir %> --git-dir=<%= @git_dir %> checkout -f

GIT_DIR=<%= @git_dir %>
WORK_TREE=<%= @working_dir %>

export RAILS_ENV=production

while read oldrev newrev ref
do
    if [[ $ref =~ .*/master$ ]];
    then
        echo "Master ref received.  Deploying master branch to production..."
        mkdir -p $WORK_TREE
        git --work-tree=$WORK_TREE --git-dir=$GIT_DIR checkout -f
        mkdir -p $WORK_TREE/shared/pids $WORK_TREE/shared/sockets $WORK_TREE/shared/log

        # start deploy tasks
        cd $WORK_TREE
        echo 'Running bundle install...'
        bundle install
        echo 'Copying key file...'
        cp <%= @keys_file %> config/
        echo 'Creating database...'
        rake db:create
        echo 'Migrate database...'
        rake db:migrate
        echo 'Precompiling assets...'
        rake assets:precompile
        echo 'Configure production log...'
        touch log/prodution.log
        chmod 0666 log/production.log
        nginx -s reload
        # end deploy tasks
        echo "Git hooks deploy complete"
    else
        echo "Ref $ref successfully received.  Doing nothing: only the master branch may be deployed on this server."
    fi
done
